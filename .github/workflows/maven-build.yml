name: Dev Java CI with Maven
on:
  push:
    branches: [ dev ]
#  pull_request:
#    branches: [ main ]

jobs: 
  envbranch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Check the branch and select the envirnoment
        id: branch_check
        run: |
          echo "Running on branch ${{ github.ref }}"
          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "env_name=Dev" >> $GITHUB_OUTPUT
          fi
      - name: Use variable setup in previous step
        run: echo "Using envirnoment ${{ steps.branch_check.outputs.env_name }}"
    outputs:
      env_name: ${{ steps.branch_check.outputs.env_name }} 
  build:  
    runs-on: ubuntu-latest
    needs: envbranch
    
    environment: ${{ needs.envbranch.outputs.env_name }}
      #name: ${{ needs.envbranch.outputs.env_name }}  
    env:
      TOKEN: ${{ secrets.TOKEN }}
      NAME: ${{ vars.NAME }}
      URL: ${{ vars.URL }} 
    steps:
      - name: print vars values
        run: |
          echo "$TOKEN"
          echo "$NAME"
          echo "$URL"
  deploy:
    runs-on: ubuntu-latest
    needs: 
      - envbranch
      - build
      
    environment:
      name: ${{ needs.envbranch.outputs.env_name }}
    env:
      TOKEN: ${{ secrets.TOKEN }}
      NAME: ${{ vars.NAME }}
      URL: ${{ vars.URL }}
    steps:    
      # Update the backend service to use the new image.
      - name: Deploy
        run: echo "deploying in Dev env...."
  deployonqa:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    needs: 
      - envbranch
      - build
      - deploy
    environment:
     name: QA
    env:
      TOKEN: ${{ secrets.TOKEN }}
      NAME: ${{ vars.NAME }}
      URL: ${{ vars.URL }}
    steps:  
      - name: print vars values
        run: echo "deploying on QA"
